<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Teacher Profile - ClassGuard</title>
    <link rel="stylesheet" href="styles-scheduling.css" />
    <link rel="stylesheet" href="styles-modern.css" />
    <link rel="stylesheet" href="chatbot.css" />
    <link rel="stylesheet" href="attendance.css" />
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-brand">ClassGuard</div>
      <div class="nav-links">
        <a href="scheduling.html">Dashboard</a>
        <a href="about.html">About</a>
        <a href="#" onclick="logout()">Logout</a>
      </div>
    </nav>

    <main style="padding: 2rem; max-width: 900px; margin: 0 auto">
      <header style="display: flex; align-items: center; gap: 16px">
        <div
          id="avatar-container"
          style="
            width: 96px;
            height: 96px;
            border-radius: 12px;
            overflow: hidden;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            color: #667eea;
          "
        >
          <img
            id="avatar-img"
            src=""
            alt="Avatar"
            style="width: 100%; height: 100%; object-fit: cover; display: none"
          />
          <span id="avatar-letter">T</span>
        </div>
        <div>
          <h1 id="profile-name">Teacher</h1>
          <div id="profile-username" style="color: #666">@teacher</div>
        </div>
      </header>

      <section style="margin-top: 18px">
        <h2>Profile</h2>
        <div style="display: flex; gap: 18px; flex-wrap: wrap">
          <div style="flex: 1; min-width: 240px">
            <label>Full name</label>
            <input
              id="input-name"
              style="width: 100%; padding: 8px; margin-top: 6px"
            />
          </div>
          <div style="flex: 1; min-width: 240px">
            <label>Username (cannot change)</label>
            <input
              id="input-username"
              disabled
              style="
                width: 100%;
                padding: 8px;
                margin-top: 6px;
                background: #f5f5f5;
              "
            />
          </div>
          <div style="flex: 1; min-width: 240px">
            <label>Subject</label>
            <input
              id="input-subject"
              style="width: 100%; padding: 8px; margin-top: 6px"
            />
          </div>
        </div>

        <div style="margin-top: 12px">
          <button
            id="save-profile"
            style="
              padding: 10px 14px;
              background: #667eea;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
            "
          >
            Save
          </button>
          <button
            id="theme-toggle"
            style="
              padding: 10px 14px;
              margin-left: 8px;
              border-radius: 6px;
              cursor: pointer;
            "
          >
            Toggle Theme
          </button>
        </div>

        <div style="margin-top: 12px">
          <label for="avatar-input" style="display: block; margin-bottom: 6px"
            >Upload photo</label
          >
          <input id="avatar-input" type="file" accept="image/*" />
        </div>

        <div
          id="save-msg"
          style="color: green; margin-top: 10px; display: none"
        >
          Profile saved.
        </div>
      </section>

      <section style="margin-top: 20px">
        <h3>Preferences</h3>
        <div style="display: flex; gap: 12px; flex-wrap: wrap">
          <label style="display: flex; align-items: center; gap: 8px"
            ><input type="radio" name="theme" value="light" /> Light</label
          >
          <label style="display: flex; align-items: center; gap: 8px"
            ><input type="radio" name="theme" value="dark" /> Dark</label
          >
          <label style="display: flex; align-items: center; gap: 8px"
            ><input type="radio" name="theme" value="school" /> School
            (blue)</label
          >
        </div>
      </section>

      <section style="margin-top: 20px">
        <h3>Account</h3>
        <div style="color: #666">
          Change your password (client-side demo only)
        </div>
        <div
          style="display: flex; gap: 12px; margin-top: 8px; max-width: 420px"
        >
          <input
            id="input-password"
            placeholder="New password"
            style="flex: 1; padding: 8px"
          />
          <button
            id="change-password"
            style="
              padding: 8px 12px;
              background: #28a745;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
            "
          >
            Change
          </button>
        </div>
        <div id="pwd-msg" style="color: green; margin-top: 8px; display: none">
          Password updated
        </div>
      </section>
    </main>

    <footer
      style="text-align: center; padding: 12px; color: #666; margin-top: 24px"
    >
      &copy; 2025 ClassGuard
      <div style="margin-top: 6px; font-size: 0.9rem; color: #666">
        Developed by Sanket Malan, Bhavesh, Nandini Sharma, Mahima Sharma and
        Mansi
      </div>
    </footer>

    <script src="teacher-auth.js"></script>
    <script src="chatbot.js" defer></script>
    <script>
      // Enforce teacher login/role like scheduling page
      (function () {
        const isLoggedIn = localStorage.getItem("isLoggedIn");
        const role = localStorage.getItem("role");
        if (!isLoggedIn || role !== "teacher") {
          window.location.href = "choose-login.html";
        }
      })();

      function applyTheme(value) {
        document.documentElement.dataset.theme = value;
        if (value === "dark") {
          document.body.style.background = "#0f1724";
          document.body.style.color = "#e6eef8";
        } else if (value === "school") {
          document.body.style.background = "#fff7f0";
          document.body.style.color = "#0f1724";
        } else {
          document.body.style.background = "";
          document.body.style.color = "";
        }
      }

      function loadProfile() {
        const username = localStorage.getItem("username") || "";
        const teachers = JSON.parse(
          localStorage.getItem("teachersRegistered") || "[]"
        );
        const teacher = teachers.find((t) => t.username === username) || {
          name: username,
          username: username,
          subject: "",
        };
        document.getElementById("profile-name").textContent =
          teacher.name || "Teacher";
        document.getElementById("profile-username").textContent =
          "@" + (teacher.username || "teacher");
        document.getElementById("input-name").value = teacher.name || "";
        document.getElementById("input-username").value =
          teacher.username || "";
        document.getElementById("input-subject").value = teacher.subject || "";

        // avatar
        const avatarKey = "avatar_" + (teacher.username || username);
        const avatar = localStorage.getItem(avatarKey);
        const imgEl = document.getElementById("avatar-img");
        const letterEl = document.getElementById("avatar-letter");
        if (avatar) {
          imgEl.src = avatar;
          imgEl.style.display = "block";
          letterEl.style.display = "none";
        } else {
          letterEl.textContent =
            teacher.name && teacher.name[0]
              ? teacher.name[0].toUpperCase()
              : "T";
          imgEl.style.display = "none";
          letterEl.style.display = "block";
        }

        const theme = localStorage.getItem("theme") || "light";
        const radios = document.getElementsByName("theme");
        radios.forEach((r) => {
          if (r.value === theme) r.checked = true;
        });
        applyTheme(theme);
      }

      document
        .getElementById("save-profile")
        .addEventListener("click", function () {
          const username = document.getElementById("input-username").value;
          const teachers = JSON.parse(
            localStorage.getItem("teachersRegistered") || "[]"
          );
          const idx = teachers.findIndex((s) => s.username === username);
          const name = document.getElementById("input-name").value.trim();
          const subject = document.getElementById("input-subject").value.trim();
          if (idx >= 0) {
            teachers[idx].name = name;
            teachers[idx].subject = subject;
            localStorage.setItem(
              "teachersRegistered",
              JSON.stringify(teachers)
            );
          } else {
            teachers.push({ name, username, password: "password", subject });
            localStorage.setItem(
              "teachersRegistered",
              JSON.stringify(teachers)
            );
          }
          document.getElementById("save-msg").style.display = "block";
          setTimeout(
            () => (document.getElementById("save-msg").style.display = "none"),
            2500
          );
        });

      document
        .getElementById("change-password")
        .addEventListener("click", function () {
          const username = document.getElementById("input-username").value;
          const pwd = document.getElementById("input-password").value;
          if (pwd.length < 3) {
            alert("Password must be at least 3 characters");
            return;
          }
          const teachers = JSON.parse(
            localStorage.getItem("teachersRegistered") || "[]"
          );
          const idx = teachers.findIndex((s) => s.username === username);
          if (idx >= 0) {
            teachers[idx].password = pwd;
            localStorage.setItem(
              "teachersRegistered",
              JSON.stringify(teachers)
            );
            document.getElementById("pwd-msg").style.display = "block";
            setTimeout(
              () => (document.getElementById("pwd-msg").style.display = "none"),
              2500
            );
          } else {
            alert("User record not found");
          }
        });

      document.getElementsByName("theme").forEach((r) =>
        r.addEventListener("change", function () {
          localStorage.setItem("theme", this.value);
          applyTheme(this.value);
        })
      );

      // avatar input handling
      const teacherAvatarInput = document.getElementById("avatar-input");
      if (teacherAvatarInput) {
        teacherAvatarInput.addEventListener("change", function () {
          const file = this.files && this.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (e) {
            const username =
              document.getElementById("input-username").value || "";
            const key = "avatar_" + username;
            try {
              localStorage.setItem(key, e.target.result);
            } catch (err) {
              alert("Unable to save image: " + err.message);
            }
            const img = document.getElementById("avatar-img");
            const letter = document.getElementById("avatar-letter");
            if (img) {
              img.src = e.target.result;
              img.style.display = "block";
            }
            if (letter) {
              letter.style.display = "none";
            }
          };
          reader.readAsDataURL(file);
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        loadProfile();
        try {
          const role = localStorage.getItem("role") || "teacher";
          const username = localStorage.getItem("username") || "";
          Chatbot.init({ role: role, name: username });
        } catch (e) {
          console.warn("Chatbot init error", e);
        }
      });
    </script>
  </body>
</html>
